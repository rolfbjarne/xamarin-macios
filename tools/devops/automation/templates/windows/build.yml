parameters:

- name: statusContext
  type: string 
  default: 'Windows Integration Tests'

- name: isPR
  type: boolean

- name: repositoryAlias
  type: string
  default: self

- name: commit
  type: string
  default: HEAD

- name: uploadPrefix
  type: string
  default: '$(MaciosUploadPrefix)'

- name: githubToken
  type: string

- name: xqaCertPass
  type: string

steps:

- template: ../common/checkout.yml
  parameters:
    isPR: ${{ parameters.isPR }}
    repositoryAlias: ${{ parameters.repositoryAlias }}
    commit: ${{ parameters.commit }}

- pwsh: $(System.DefaultWorkingDirectory)/xamarin-macios/tools/devops/automation/scripts/show_env.ps1
  displayName: 'Dump Environment'
  env:
    XMA_PASSWORD: $(XMA.Password)

- task: DownloadPipelineArtifact@2
  displayName: Download artifacts
  inputs:
    allowFailedBuilds: true
    path: $(Build.SourcesDirectory)/artifacts

- pwsh: |
    Get-ChildItem $(Build.SourcesDirectory)/artifacts -Recurse 
  displayName: "Debug downloads"

- pwsh: |
    try {
      Write-Host "Looking in '$(Build.SourcesDirectory)\artifacts"
      Get-ChildItem "$(Build.SourcesDirectory)\artifacts" -Recurse
    } catch {
      Write-Host "Exception occured: $_"
    }
  displayName: 'List downloaded artifacts'
  continueOnError: true

- task: UseDotNet@2
  inputs:
    version: 7.0.102

- pwsh: |
    Write-Host "Network Configuration:"
    Get-NetIPConfiguration
    Write-Host "IP Addresses:"
    Get-NetIPAddress
  displayName: 'Show Network Configuration'
  continueOnError: true

- pwsh: $(System.DefaultWorkingDirectory)/xamarin-macios/tools/devops/automation/scripts/show_env.ps1
  displayName: 'Show Environment'

- pwsh: |
    & dotnet --version
    & dotnet --info
    & dotnet workload list
    # We don't care if anything went wrong here.
    exit 0
  displayName: 'Show .NET info'
  continueOnError: true

# This task fixes errors such as these:
#     error MSB4242: SDK Resolver Failure: "The SDK resolver "NuGetSdkResolver" failed while attempting to resolve the SDK "Microsoft.Build.NoTargets/3.3.0".
#                    Exception: "NuGet.Packaging.Core.PackagingException: Unable to find fallback package folder 'D:\Program Files (x86)\Microsoft Visual Studio\Shared\NuGetPackages'.
- pwsh: |
    try {
      New-Item -Path "D:\Program Files (x86)\Microsoft SDKs\" -Name "NuGetPackages" -ItemType "directory"
    } catch {
      Write-Host "Exception occured: $_"
    }
    try {
      New-Item -Path "D:\Program Files (x86)\Microsoft SDKs\" -Name "Shared" -ItemType "directory"
    } catch {
      Write-Host "Exception occured: $_"
    }
    try {
      New-Item -Path "D:\Program Files (x86)\Microsoft SDKs\Shared\" -Name "NuGetPackages" -ItemType "directory"
    } catch {
      Write-Host "Exception occured: $_"
    }
    try {
      New-Item -Path "D:\Program Files (x86)\Microsoft Visual Studio\Shared\NuGetPackages" -Name "NuGetPackages" -ItemType "directory"
    } catch {
      Write-Host "Exception occured: $_"
    }
  displayName: 'Create directories for NuGet'
  continueOnError: true

- pwsh: |
    & dotnet build "$(Build.SourcesDirectory)/xamarin-macios/tests/dotnet/Windows/InstallDotNet.csproj" `
    --verbosity quiet `
    "-bl:$(Build.SourcesDirectory)/xamarin-macios/tests/dotnet/Windows/install.binlog" `
    -p:DisableImplicitNuGetFallbackFolder=true
  displayName: 'Install custom .NET'

- pwsh: |
    $Env:DOTNET = "$(Build.SourcesDirectory)\xamarin-macios\tests\dotnet\Windows\bin\dotnet\dotnet.exe"
    & dotnet build "$(Build.SourcesDirectory)/xamarin-macios/tests/dotnet/Windows/InstallDotNet.csproj" `
      --verbosity quiet `
      "-bl:$(Build.SourcesDirectory)/xamarin-macios/tests/dotnet/Windows/install-workloads.binlog" `
      -p:DisableImplicitNuGetFallbackFolder=true `
      -t:Install
  displayName: 'Install workloads'

- task: DownloadPipelineArtifact@2
  displayName: Download Build.props
  inputs:
    patterns: '**/Build.props'
    allowFailedBuilds: true
    path: $(Build.SourcesDirectory)/artifacts/tmp

- pwsh: |
    $path = "$(Build.SourcesDirectory)/artifacts/tmp/${{ parameters.uploadPrefix }}Build.props/Build.props"
    Write-Host "Move $path to xamarin-macios"
    mv $path ./xamarin-macios
  displayName: Relocate Build.props
  workingDirectory: $(Build.SourcesDirectory)

# this step replaces the test-libraries dir
- pwsh: |
    $zip = "$(Build.SourcesDirectory)/artifacts/${{ parameters.uploadPrefix }}package-test-libraries/package-test-libraries.zip"
    $target = "$(Build.SourcesDirectory)/xamarin-macios"
    Expand-Archive -Force $zip -DestinationPath $target
    Get-ChildItem "$target" -Recurse
  workingDirectory: $(Build.SourcesDirectory)/xamarin-macios
  displayName: Expand test libraries.
  timeoutInMinutes: 10

- pwsh: |
    & $(Build.SourcesDirectory)\xamarin-macios\tests\dotnet\Windows\bin\dotnet\dotnet.exe `
        nuget push `
        "$(Build.SourcesDirectory)\xamarin-macios\tests\test-libraries\nugets\FrameworksInRuntimesNativeDirectory\bin\Release\Xamarin.Tests.FrameworksInRuntimesNativeDirectory.1.0.0.nupkg" `
        --source "$(Build.SourcesDirectory)\xamarin-macios\tests\.nuget\packages"
  displayName: 'Build dependencies for .NET tests'
  continueOnError: true

- pwsh: |
    Get-NetIPAddress | Write-Host
  displayName: 'Print network info A'
  continueOnError: true

- pwsh: |
    & ipconfig
  displayName: 'Print network info B'
  continueOnError: true

- pwsh: |
    $runsettings = @"
    <?xml version="1.0" encoding="utf-8"?>
    <RunSettings>
      <RunConfiguration>
        <DotNetHostPath>$(Build.SourcesDirectory)\xamarin-macios\tests\dotnet\Windows\bin\dotnet\dotnet.exe</DotNetHostPath>
      </RunConfiguration>
    </RunSettings>
    "@
    Set-Content -Path $(Build.SourcesDirectory)/xamarin-macios/tests/dotnet/Windows/config.runsettings -Value $runsettings
    Get-Content -Path $(Build.SourcesDirectory)/xamarin-macios/tests/dotnet/Windows/config.runsettings | Write-Host
  displayName: 'Create runsettings for .NET tests'

- pwsh: |
    $Env:PATH = "$(Build.SourcesDirectory)\xamarin-macios\tests\dotnet\Windows\bin\dotnet;$env:PATH"
    $Env:DOTNET = "$(Build.SourcesDirectory)\xamarin-macios\tests\dotnet\Windows\bin\dotnet\dotnet.exe"
    & $(Build.SourcesDirectory)\xamarin-macios\tests\dotnet\Windows\bin\dotnet\dotnet.exe `
       run --project "$(Build.SourcesDirectory)\xamarin-macios\tools\sshenv\sshenv.csproj" `
       -- `
       --host $Env:MAC_AGENT_IP `
       --user builder `
       --penv XMA_PASSWORD `
       ls -la
  displayName: 'Check the Mac'
  continueOnError: true
  timeoutInMinutes: 5
  env:
    XMA_PASSWORD: $(XMA.Password)

- pwsh: |
    Import-Module $Env:SYSTEM_DEFAULTWORKINGDIRECTORY/xamarin-macios/tools/devops/automation/scripts/MaciosCI.psd1
    $uploadDirectory = New-RemoteMacInstallDirectory -SourcesDirectory "$(Build.SourcesDirectory)" -ArtifactsDirectory "$(Build.SourcesDirectory)/artifacts"
    Install-DotNetOnRemoteMac `
      -SourcesDirectory "$(Build.SourcesDirectory)" `
      -DotNet "$(Build.SourcesDirectory)\xamarin-macios\tests\dotnet\Windows\bin\dotnet\dotnet.exe" `
      -UploadDirectory "$(Build.SourcesDirectory)/artifacts/remote-mac-upload" `
      -RemoteHost $Env:MAC_AGENT_IP `
      -RemoteUserName builder `
      -RemotePasswordEnvironmentVariable XMA_PASSWORD
  displayName: 'Install .NET on Mac'
  continueOnError: true
  timeoutInMinutes: 30
  env:
    XMA_PASSWORD: $(XMA.Password)

- pwsh: |
    Import-Module $Env:SYSTEM_DEFAULTWORKINGDIRECTORY/xamarin-macios/tools/devops/automation/scripts/MaciosCI.psd1
    $Env:DOTNET = "$(Build.SourcesDirectory)\xamarin-macios\tests\dotnet\Windows\bin\dotnet\dotnet.exe"
    # maccore
    Write-Host "Zipping maccore"
    # Compress-Archive -Path "$Env:SYSTEM_DEFAULTWORKINGDIRECTORY/maccore" -DestinationPath "$Env:SYSTEM_DEFAULTWORKINGDIRECTORY/maccore.zip"
    git --git-dir "$Env:SYSTEM_DEFAULTWORKINGDIRECTORY/maccore/.git" archive --output "$Env:SYSTEM_DEFAULTWORKINGDIRECTORY/maccore.zip" HEAD --prefix maccore/
    Write-Host "Zipping maccore done"
    Invoke-SshEnvUpload `
      -SourcesDirectory "$(Build.SourcesDirectory)" `
      -DotNet "$Env:DOTNET" `
      -RemoteHost "$Env:MAC_AGENT_IP" `
      -RemoteUserName "builder" `
      -RemotePasswordEnvironmentVariable "XMA_PASSWORD" `
      -ThrowIfError $true `
      -Source "$Env:SYSTEM_DEFAULTWORKINGDIRECTORY/maccore.zip" `
      -Target "/Users/builder/remote_build_testing/src/maccore.zip"
    Invoke-SshEnvCommand `
      -SourcesDirectory "$(Build.SourcesDirectory)" `
      -DotNet "$Env:DOTNET" `
      -RemoteHost "$Env:MAC_AGENT_IP" `
      -RemoteUserName "builder" `
      -RemotePasswordEnvironmentVariable "XMA_PASSWORD" `
      -ThrowIfError $true `
      -- `
      unzip -d "/Users/builder/remote_build_testing/src/" "/Users/builder/remote_build_testing/src/maccore.zip"

    # xamarin-macios
    Write-Host "Zipping xamarin-macios"
    # Compress-Archive -Path "$Env:SYSTEM_DEFAULTWORKINGDIRECTORY/xamarin-macios" -DestinationPath "$Env:SYSTEM_DEFAULTWORKINGDIRECTORY/xamarin-macios.zip"
    git --git-dir "$Env:SYSTEM_DEFAULTWORKINGDIRECTORY/xamarin-macios/.git" archive --output "$Env:SYSTEM_DEFAULTWORKINGDIRECTORY/xamarin-macios.zip" HEAD --prefix xamarin-macios/
    Write-Host "Zipping xamarin-macios done"
    Invoke-SshEnvUpload `
      -SourcesDirectory "$(Build.SourcesDirectory)" `
      -DotNet "$Env:DOTNET" `
      -RemoteHost "$Env:MAC_AGENT_IP" `
      -RemoteUserName "builder" `
      -RemotePasswordEnvironmentVariable "XMA_PASSWORD" `
      -ThrowIfError $true `
      -Source "$Env:SYSTEM_DEFAULTWORKINGDIRECTORY/xamarin-macios.zip" `
      -Target "/Users/builder/remote_build_testing/src/xamarin-macios.zip"
    Invoke-SshEnvCommand `
      -SourcesDirectory "$(Build.SourcesDirectory)" `
      -DotNet "$Env:DOTNET" `
      -RemoteHost "$Env:MAC_AGENT_IP" `
      -RemoteUserName "builder" `
      -RemotePasswordEnvironmentVariable "XMA_PASSWORD" `
      -ThrowIfError $true `
      -- `
      unzip -d "/Users/builder/remote_build_testing/src/" "/Users/builder/remote_build_testing/src/xamarin-macios.zip"

    # let's see what we did
    Invoke-SshEnvCommand `
      -SourcesDirectory "$(Build.SourcesDirectory)" `
      -DotNet "$Env:DOTNET" `
      -RemoteHost "$Env:MAC_AGENT_IP" `
      -RemoteUserName "builder"`
      -RemotePasswordEnvironmentVariable "XMA_PASSWORD" `
      -ThrowIfError $false `
      -- `
      ls -la "/Users/builder/remote_build_testing/src/"
    Invoke-SshEnvCommand `
      -SourcesDirectory "$(Build.SourcesDirectory)" `
      -DotNet "$Env:DOTNET" `
      -RemoteHost "$Env:MAC_AGENT_IP" `
      -RemoteUserName "builder"`
      -RemotePasswordEnvironmentVariable "XMA_PASSWORD" `
      -ThrowIfError $false `
      -- `
      ls -la "/Users/builder/remote_build_testing/src/xamarin-macios"
  displayName: 'Copy source code to Mac'
  continueOnError: true
  timeoutInMinutes: 30
  env:
    XMA_PASSWORD: $(XMA.Password)

- pwsh: |
    Import-Module $Env:SYSTEM_DEFAULTWORKINGDIRECTORY/xamarin-macios/tools/devops/automation/scripts/MaciosCI.psd1
    $Env:DOTNET = "$(Build.SourcesDirectory)\xamarin-macios\tests\dotnet\Windows\bin\dotnet\dotnet.exe"
    Invoke-SshEnvCommand `
      -SourcesDirectory "$(Build.SourcesDirectory)" `
      -DotNet "$Env:DOTNET" `
      -RemoteHost "$Env:MAC_AGENT_IP" `
      -RemoteUserName "builder" `
      -RemotePasswordEnvironmentVariable "XMA_PASSWORD" `
      -ThrowIfError $true `
      -- `
      chmod +x /Users/builder/remote_build_testing/src/xamarin-macios/tests/dotnet/Windows/install-xcode.sh
    Invoke-SshEnvCommand `
      -SourcesDirectory "$(Build.SourcesDirectory)" `
      -DotNet "$Env:DOTNET" `
      -RemoteHost "$Env:MAC_AGENT_IP" `
      -RemoteUserName "builder" `
      -RemotePasswordEnvironmentVariable "XMA_PASSWORD" `
      -ThrowIfError $true `
      -- `
      /Users/builder/remote_build_testing/src/xamarin-macios/tests/dotnet/Windows/install-xcode.sh "$Env:AUTH_TOKEN_GITHUB_COM" "$Env:BUILD_SOURCEVERSION"
  displayName: 'Install Xcode on Mac'
  continueOnError: true
  timeoutInMinutes: 60
  env:
    XMA_PASSWORD: $(XMA.Password)
    AUTH_TOKEN_GITHUB_COM: ${{ parameters.gitHubToken }}

- pwsh: |
    Import-Module $Env:SYSTEM_DEFAULTWORKINGDIRECTORY/xamarin-macios/tools/devops/automation/scripts/MaciosCI.psd1
    $Env:DOTNET = "$(Build.SourcesDirectory)\xamarin-macios\tests\dotnet\Windows\bin\dotnet\dotnet.exe"
    Invoke-SshEnvCommand `
      -SourcesDirectory "$(Build.SourcesDirectory)" `
      -DotNet "$Env:DOTNET" `
      -RemoteHost "$Env:MAC_AGENT_IP" `
      -RemoteUserName "builder" `
      -RemotePasswordEnvironmentVariable "XMA_PASSWORD" `
      -ThrowIfError $true `
      -- `
      $Env:MAC_AGENT_BUILD_SOURCESDIRECTORY/xamarin-macios/tests/dotnet/Windows/install-provisioning-profiles.sh "$Env:AUTH_TOKEN_GITHUB_COM" "$Env:XQA_CERT_PASS"
  displayName: 'Install provisioning profiles on Mac'
  continueOnError: true
  timeoutInMinutes: 5
  env:
    XMA_PASSWORD: $(XMA.Password)
    AUTH_TOKEN_GITHUB_COM: ${{ parameters.gitHubToken }}
    XQA_CERT_PASS: ${{ parameters.xqaCertPass }}

- pwsh: |
    $Env:DOTNET = "$(Build.SourcesDirectory)\xamarin-macios\tests\dotnet\Windows\bin\dotnet\dotnet.exe"
    & $Env:DOTNET `
      build `
      "$(Build.SourcesDirectory)\xamarin-macios\tests\dotnet\MySimpleApp\iOS\MySimpleApp.csproj" `
      /p:ServerAddress=$Env:MAC_AGENT_IP `
      /p:ServerUser=builder `
      /p:ServerPassword=$Env:XMA_PASSWORD `
      /p:_DotNetRootRemoteDirectory=/Users/builder/remote_build_testing/_build `
      /p:ExcludeTouchUnitReference=true `
      /p:ExcludeNUnitLiteReference=true `
      -v:diag `
      "-bl:/Users/builder/remote_build_testing/MySimpleApp.binlog"
  displayName: 'Try to build test on Mac'
  continueOnError: true
  timeoutInMinutes: 30
  env:
    XMA_PASSWORD: $(XMA.Password)

- pwsh: |
    $Env:DOTNET = "$(Build.SourcesDirectory)\xamarin-macios\tests\dotnet\Windows\bin\dotnet\dotnet.exe"
    & $Env:DOTNET `
        test `
        "$(Build.SourcesDirectory)/xamarin-macios/tests/dotnet/UnitTests/DotNetUnitTests.csproj" `
        --filter Category=Windows `
        --verbosity quiet `
        --settings $(Build.SourcesDirectory)/xamarin-macios/tests/dotnet/Windows/config.runsettings `
        "--results-directory:$(Build.SourcesDirectory)/xamarin-macios/jenkins-results/" `
        "--logger:console;verbosity=detailed" `
        "--logger:trx;LogFileName=$(Build.SourcesDirectory)/xamarin-macios/jenkins-results/windows-dotnet-tests.trx" `
        "--logger:html;LogFileName=$(Build.SourcesDirectory)/xamarin-macios/jenkins-results/windows-dotnet-tests.html" `
        "-bl:$(Build.SourcesDirectory)/xamarin-macios/tests/dotnet/Windows/run-dotnet-tests.binlog"
  displayName: 'Run .NET tests'
  timeoutInMinutes: 30

- pwsh: |
    $Env:DOTNET = "$(Build.SourcesDirectory)\xamarin-macios\tests\dotnet\Windows\bin\dotnet\dotnet.exe"
    $Env:ServerAddress = $Env:MAC_AGENT_IP
    $Env:ServerUser = "builder"
    $Env:ServerPassword = $Env:XMA_PASSWORD
    $Env:DOTNET_IOS_RUNTIME_IDENTIFIERS = "'ios-arm iossimulator-x86 ios-arm64 iossimulator-x64 iossimulator-arm64'"
    $Env:_DotNetRootRemoteDirectory = "/Users/builder/remote_build_testing/_build/"
    Add-Content $(Build.SourcesDirectory)/xamarin-macios/tests/test.config "`nINCLUDE_MAC=`nINCLUDE_TVOS=`nINCLUDE_MACCATALYST=`n"
    & $Env:DOTNET `
        test `
        "$(Build.SourcesDirectory)/xamarin-macios/tests/dotnet/UnitTests/DotNetUnitTests.csproj" `
        --filter Category=RemoteWindows `
        --verbosity quiet `
        --settings $(Build.SourcesDirectory)/xamarin-macios/tests/dotnet/Windows/config.runsettings `
        "--results-directory:$(Build.SourcesDirectory)/xamarin-macios/jenkins-results/windows-remote-tests/" `
        "--logger:console;verbosity=detailed" `
        "--logger:trx;LogFileName=$(Build.SourcesDirectory)/xamarin-macios/jenkins-results/windows-remote-dotnet-tests.trx" `
        "--logger:html;LogFileName=$(Build.SourcesDirectory)/xamarin-macios/jenkins-results/windows-remote-dotnet-tests.html" `
        "-bl:$(Build.SourcesDirectory)/xamarin-macios/tests/dotnet/Windows/windows-remote-dotnet-tests.binlog"
  displayName: 'Run .NET tests remotely'
  timeoutInMinutes: 120
  env:
    XMA_PASSWORD: $(XMA.Password)

- pwsh: |
    Import-Module $Env:SYSTEM_DEFAULTWORKINGDIRECTORY/xamarin-macios/tools/devops/automation/scripts/MaciosCI.psd1
    $Env:DOTNET = "$(Build.SourcesDirectory)\xamarin-macios\tests\dotnet\Windows\bin\dotnet\dotnet.exe"
    # Zip up all the binlogs into one file
    Invoke-SshEnvCommand `
      -SourcesDirectory "$(Build.SourcesDirectory)" `
      -DotNet "$Env:DOTNET" `
      -RemoteHost "$Env:MAC_AGENT_IP" `
      -RemoteUserName "builder" `
      -RemotePasswordEnvironmentVariable "XMA_PASSWORD" `
      -ThrowIfError $true `
      -- `
      $Env:MAC_AGENT_BUILD_SOURCESDIRECTORY/xamarin-macios/tests/dotnet/Windows/collect-binlogs.sh "$Env:MAC_AGENT_BUILD_SOURCESDIRECTORY" "/Users/builder/remote_build_testing"

    # Copy the zip from the remote Mac to this machine
    Invoke-SshEnvDownload `
      -SourcesDirectory "$(Build.SourcesDirectory)" `
      -DotNet "$Env:DOTNET" `
      -RemoteHost "$Env:MAC_AGENT_IP" `
      -RemoteUserName "builder" `
      -RemotePasswordEnvironmentVariable "XMA_PASSWORD" `
      -ThrowIfError $true `
      -Source "/Users/builder/remote_build_testing/windows-remote-binlogs.zip" `
      -Target "$(Build.ArtifactStagingDirectory)/windows-binlogs/windows-remote-binlogs.zip"
  displayName: 'Fetch remote binlogs'
  timeoutInMinutes: 5
  condition: always()
  continueOnError: true
  env:
    XMA_PASSWORD: $(XMA.Password)

- pwsh: |
    $Env:DOTNET = "$(Build.SourcesDirectory)\xamarin-macios\tests\dotnet\Windows\bin\dotnet\dotnet.exe"
    & $Env:DOTNET `
        test `
        "$(Build.SourcesDirectory)/xamarin-macios/tests/dotnet/UnitTests/DotNetUnitTests.csproj" `
        --filter Category=Windows `
        --verbosity quiet `
        "--results-directory:$(Build.SourcesDirectory)/xamarin-macios/jenkins-results/" `
        "--logger:console;verbosity=detailed" `
        "--logger:trx;LogFileName=$(Build.SourcesDirectory)/xamarin-macios/jenkins-results/windows-dotnet-tests.trx" `
        "--logger:html;LogFileName=$(Build.SourcesDirectory)/xamarin-macios/jenkins-results/windows-dotnet-tests.html" `
        "-bl:$(Build.SourcesDirectory)/xamarin-macios/tests/dotnet/Windows/run-dotnet-tests.binlog"
  displayName: 'Run .NET tests on Windows'
  timeoutInMinutes: 30

- pwsh: |
    Import-Module $Env:SYSTEM_DEFAULTWORKINGDIRECTORY\xamarin-macios\tools\devops\automation\scripts\MaciosCI.psd1
    $configFile = "$(Build.SourcesDirectory)\artifacts\build-configuration\configuration.json"
    $config = Import-BuildConfiguration -ConfigFile $configFile
    $config | Write-Host
  name: configuration
  continueOnError: true
  displayName: 'Parse build configuration'
  timeoutInMinutes: 1

- pwsh: $(System.DefaultWorkingDirectory)/xamarin-macios/tools/devops/automation/scripts/run-generator-tests-on-windows.ps1
  displayName: 'Run generator tests'

# Archive files for the Html Report so that the report can be easily uploaded as artifacts of the build.
- task: ArchiveFiles@1
  displayName: 'Archive HtmlReport'
  inputs:
    rootFolder: '$(Build.SourcesDirectory)/xamarin-macios/jenkins-results'
    includeRootFolder: false
    archiveFile: '$(Build.ArtifactStagingDirectory)/HtmlReport.zip'
  continueOnError: true
  condition: succeededOrFailed()

# Create HtmlReport artifact. This serves two purposes:
# 1. It is the way we are going to share the HtmlReport with the publish_html job that is executed on a Windows machine.
# 2. Users can download this if they want.
- task: PublishPipelineArtifact@1
  displayName: 'Publish Artifact: HtmlReport'
  inputs:
    targetPath: '$(Build.ArtifactStagingDirectory)/HtmlReport.zip'
    artifactName: '${{ parameters.uploadPrefix }}HtmlReport-windows-integration-$(System.JobAttempt)'
  continueOnError: true
  condition: succeededOrFailed()

- pwsh: |
    Write-Host "Run windows tests."
    Write-Host "Mac agent to be used:"
    Write-Host "Mac agent pool: $Env:MAC_AGENT_POOL"
    Write-Host "Mac agent name: $Env:MAC_AGENT_NAME"
    Write-Host "Mac agent IP: $Env:MAC_AGENT_IP"
    Write-Host "Mac agent SYSTEM_DEFAULTWORKINGDIRECTORY: $Env:MAC_AGENT_SYSTEM_DEFAULTWORKINGDIRECTORY"
    Write-Host "Mac agent BUILD_SOURCESDIRECTORY: $Env:MAC_AGENT_BUILD_SOURCESDIRECTORY"
  displayName: Run tests

# Upload all the binlogs
# Copy all the binlogs to a separate directory, keeping directory structure.
- pwsh: |
    $sourceDir = '$(Build.SourcesDirectory)\xamarin-macios'
    $targetDir = '$(Build.ArtifactStagingDirectory)\windows-binlogs'
    New-Item -Path "$targetDir" -ItemType "directory" -Force

    $binlogs = Get-ChildItem $sourceDir -Recurse -Include "*.binlog"
    foreach ($binlog in $binlogs) {
        $targetFile = $targetDir + $binlog.FullName.SubString($sourceDir.Length);
        New-Item -ItemType File -Path $targetFile -Force
        Copy-Item $binlog.FullName -destination $targetFile
    }
  displayName: Copy all binlogs
  continueOnError: true
  condition: succeededOrFailed()

# Publish all the binlogs we collected in the previous step
- task: PublishPipelineArtifact@1
  displayName: 'Publish Artifact: Windows binlogs'
  inputs:
    targetPath: $(Build.ArtifactStagingDirectory)/windows-binlogs
    artifactName: windows-binlogs-test-$(Build.BuildId)-$(System.JobAttempt)
  continueOnError: true
  condition: succeededOrFailed()

# Make sure to report any errors
- pwsh: |
    Import-Module $Env:SYSTEM_DEFAULTWORKINGDIRECTORY\xamarin-macios\tools\devops\automation\scripts\MaciosCI.psd1
    $githubComments = New-GitHubCommentsObjectFromUrl -Url "$(Build.Repository.Uri)" -Token $(GitHub.Token) -Hash $Env:COMMENT_HASH
    $statuses = New-GitHubStatusesObjectFromUrl -Url "$(Build.Repository.Uri)" -Token $(GitHub.Token)

    if (Test-Path -Path "$Env:GITHUB_FAILURE_COMMENT_FILE" -PathType Leaf)  {
      $statuses.SetStatus("error", "${{ parameters.statusContext }} failed.", "${{ parameters.statusContext }}")
      $githubComments.NewCommentFromFile("${{ parameters.statusContext }} failed", ":x:", "$Env:GITHUB_FAILURE_COMMENT_FILE")
    } elseif ("$($Env:AGENT_JOBSTATUS)" -ne "Succeeded") {
      $statuses.SetStatus("error", "${{ parameters.statusContext }} failed.", "${{ parameters.statusContext }}")
      $message = ":x: $($Env:AGENT_JOBSTATUS) :x:"
      $githubComments.NewCommentFromMessage("${{ parameters.statusContext }} failed", ":x:", $message)
    } else {
      $statuses.SetStatus("success", "${{ parameters.statusContext }} passed.", "${{ parameters.statusContext }}")
      $message = ":white_check_mark: **All** ${{ parameters.statusContext }} passed."
      $githubComments.NewCommentFromMessage("${{ parameters.statusContext }} passed", ":computer:", $message)
    }
  displayName: 'Report results to GitHub'
  timeoutInMinutes: 5
  condition: always() # in particular we care if something failed, but let's always run just in case
  continueOnError: true
  env:
    CONTEXT: ${{ parameters.statusContext }}
    GITHUB_TOKEN: $(GitHub.Token)
    SYSTEM_ACCESSTOKEN: $(System.AccessToken)
    TEST_BOT: $(Agent.Name)
    ${{ if eq(parameters.repositoryAlias, 'self') }}:
      COMMENT_HASH: $(fix_commit.GIT_HASH)
    ${{ else }}:
      COMMENT_HASH: $(Build.SourceVersion)

- pwsh: |
    Import-Module $Env:SYSTEM_DEFAULTWORKINGDIRECTORY\xamarin-macios\tools\devops\automation\scripts\MaciosCI.psd1
    $vsts = New-VSTS -Org "devdiv" -Project "DevDiv" -Token $(MacPoolAccessToken)

    # get the pool and the agent objects and disable the bot
    $pool = $vsts.Pools.GetPool("$Env:MAC_AGENT_POOL")
    $agent = $vsts.Agents.GetAgent($pool, $Env:MAC_AGENT_NAME)
    $vsts.Agents.SetEnabled($pool, $agent, $True)
  displayName: 'Re-enabled macOS bot from pool'
  condition: always()
