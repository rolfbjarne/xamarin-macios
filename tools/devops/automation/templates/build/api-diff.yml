# Contains all the different steps to generate the diff API diffs

parameters:

- name: prID
  type: string 
  default: '' # default empty, meaning we are building in CI 

steps:

- template: ../common/status.yml
  parameters:
    status: "pending"
    description: "Change detection"
    context: "Change detection"
    githubToken: $(GitHub.Token)
    continueOnError: true
    condition: succeededOrFailed() # re-starting the daemon should not be an issue
    timeoutInMinutes: 5

- bash:  $(Build.SourcesDirectory)/xamarin-macios/tools/devops/automation/scripts/bash/compare.sh
  displayName: 'Change detection'
  condition: succeeded()
  name: detectChanges
  continueOnError: true # this isn't fatal, the github comment will show how bad this really is
  env:
    BUILD_REVISION: 'devops' # doesn't matter the exact value, any value is understood as "we're in CI"
    PR_ID:  ${{ parameters.prID }} # reusing jenkins vars, to be fixed

- task: PublishPipelineArtifact@1
  displayName: 'Publish change detection results'
  inputs:
    targetPath: '$(Build.ArtifactStagingDirectory)/change-detection.zip'
    artifactName: apicomparison
  condition: succeeded()
  continueOnError: true

- pwsh: |
    Import-Module $Env:SYSTEM_DEFAULTWORKINGDIRECTORY\xamarin-macios\tools\devops\automation\scripts\MaciosCI.psd1
    $statuses = New-GitHubStatusesObject -Org "xamarin" -Repo "xamarin-macios" -Token $(GitHub.Token)

    $msg = "$(apiGeneratorDiff.API_GENERATOR_DIFF_STATUS_MESSAGE)"
    $msg = $msg.Replace(":white_check_mark: ", "").Replace(":warning: ", "").Replace(":information_source: ", "")
    $statuses.SetStatus("$(apiGeneratorDiff.API_GENERATOR_DIFF_STATUS)", $msg, "API Diff (PR)")
  displayName: "Set change detection final status"
  timeoutInMinutes: 5
  condition: succeededOrFailed() # re-starting the daemon should not be an issue
  continueOnError: true
