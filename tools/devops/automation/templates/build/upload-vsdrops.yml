
# job that downloads the html report from the artifacts and uploads them into vsdrops.
parameters:

- name: testPrefix
  type: string 
  default: 'ios' # default context, since we started dealing with iOS devices. 

- name: runTests
  type: boolean
  default: true

- name: enableAPIDiff
  type: boolean
  default: true

steps:

- template: ../common/checkout.yml

- task: DownloadPipelineArtifact@2
  displayName: 'Download API & Generator comparison'
  inputs:
    patterns: 'apicomparison/apicomparison.zip'
    allowFailedBuilds: true
    path: $(System.DefaultWorkingDirectory)/Reports

- task: ExtractFiles@1
  displayName: 'Extract API & Generator comparison'
  inputs:
    archiveFilePatterns: '$(System.DefaultWorkingDirectory)/Reports/apicomparison/apicomparison.zip'
    destinationFolder: '$(System.DefaultWorkingDirectory)/apicomparison'

- powershell: |
    Write-Host "##vso[task.setvariable variable=STABLE_APIDIFF_PATH]$Env:SYSTEM_DEFAULTWORKINGDIRECTORY\\apidiff-stable"
    if ($Env:API_GENERATOR_DIFF_BUILT -eq "True") {
      Write-Host "##vso[task.setvariable variable=STABLE_APID_GENERATOR_DIFF_PATH]$Env:SYSTEM_DEFAULTWORKINGDIRECTORY\\apicomparison"
    }
  displayName: Publish apidiff paths
  name: apidiff # not to be confused with the displayName, this is used to later use the name of the step to access the output variables from an other job

# Upload the change detection results to vsdrops
- task: ms-vscs-artifact.build-tasks.artifactDropTask-1.artifactDropTask@0
  displayName: 'Publish change detection results to Artifact Services Drop'
  continueOnError: true
  inputs:
    dropServiceURI: 'https://devdiv.artifacts.visualstudio.com/DefaultCollection'
    dropMetadataContainerName: 'DropMetadata-ChangeDetection'
    buildNumber: 'xamarin-macios/detected-changes/$(Build.BuildNumber)/$(Build.BuildId)'
    sourcePath: $(CHANGE_DETECTION_RESULTS_PATH)
    detailedLog: true
    usePat: true
