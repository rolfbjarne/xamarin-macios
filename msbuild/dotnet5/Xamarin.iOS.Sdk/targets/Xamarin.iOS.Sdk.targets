<?xml version="1.0" encoding="utf-8"?>
<Project DefaultTargets="Build" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">

  <PropertyGroup>

    <NoStdLib>true</NoStdLib>
    <DisableExtraReferences>true</DisableExtraReferences>

    <MlaunchPath>$(XamariniOSSdkRootDirectory)bin\mlaunch</MlaunchPath>
    <RunCommand>$(MlaunchPath)</RunCommand>
    <RunArguments>-launchsim=$(OutputPath)\$(AssemblyName).app -device=:v2:runtime=com.apple.CoreSimulator.SimRuntime.iOS-13-3,devicetype=com.apple.CoreSimulator.SimDeviceType.iPhone-11</RunArguments>
  </PropertyGroup>

  <!-- Set some default values. These values can't be set in Sdk.props, because they're evaluated based on the MtouchArch property, which is not set yet in Sdk.props -->
  <PropertyGroup>
    <!-- We cannot use $(Platform) in conditions on props, because VS interprets them as valid platforms
       for the current project and makes them available for solution configurations, which fails miserably
       for iOS class library projects. By using another property name, we "opt out" of this "smart" behavior -->
    <_Platform>$(Platform)</_Platform>

    <!-- Fall back to old behavior, where the target device architecture was specified using the Platform property -->
    <TargetDeviceArchitecture Condition="'$(TargetDeviceArchitecture)' == '' And '$(_Platform)' == 'iPhoneSimulator'">Simulator</TargetDeviceArchitecture>
    <TargetDeviceArchitecture Condition="'$(TargetDeviceArchitecture)' == '' And '$(_Platform)' == 'iPhone'">Device</TargetDeviceArchitecture>

    <MtouchArch Condition="'$(MtouchArch)' == '' And '$(TargetDeviceArchitecture)' == 'Simulator'">x86_64</MtouchArch>
    <MtouchArch Condition="'$(MtouchArch)' == '' And '$(TargetDeviceArchitecture)' == 'Device'">ARM64</MtouchArch>

    <TargetDeviceArchitecture Condition="'$(TargetDeviceArchitecture)' == '' And '$(MtouchArch)' == 'x86_64'">Simulator</TargetDeviceArchitecture>
    <TargetDeviceArchitecture Condition="'$(TargetDeviceArchitecture)' == '' And '$(MtouchArch)' == 'i386'">Simulator</TargetDeviceArchitecture>
    <TargetDeviceArchitecture Condition="'$(TargetDeviceArchitecture)' == '' And '$(MtouchArch)' == 'i386, x86_64'">Simulator</TargetDeviceArchitecture>
    <TargetDeviceArchitecture Condition="'$(TargetDeviceArchitecture)' == '' And '$(MtouchArch)' == 'ARMv7'">Device</TargetDeviceArchitecture>
    <TargetDeviceArchitecture Condition="'$(TargetDeviceArchitecture)' == '' And '$(MtouchArch)' == 'ARMv7s'">Device</TargetDeviceArchitecture>
    <TargetDeviceArchitecture Condition="'$(TargetDeviceArchitecture)' == '' And '$(MtouchArch)' == 'ARM64'">Device</TargetDeviceArchitecture>
    <TargetDeviceArchitecture Condition="'$(TargetDeviceArchitecture)' == '' And '$(MtouchArch)' == 'ARMv7, ARMv7s'">Device</TargetDeviceArchitecture>
    <TargetDeviceArchitecture Condition="'$(TargetDeviceArchitecture)' == '' And '$(MtouchArch)' == 'ARMv7, ARM64'">Device</TargetDeviceArchitecture>
    <TargetDeviceArchitecture Condition="'$(TargetDeviceArchitecture)' == '' And '$(MtouchArch)' == 'ARMv7s, ARM64'">Device</TargetDeviceArchitecture>
    <TargetDeviceArchitecture Condition="'$(TargetDeviceArchitecture)' == '' And '$(MtouchArch)' == 'ARMv7, ARMv7s, ARM64'">Device</TargetDeviceArchitecture>

  </PropertyGroup>

  <!-- Check if we're a binding project or not -->
  <PropertyGroup Condition="'$(IsBindingProject)' == '' And '$(OutputType)' == 'Library'">
    <_ExpandedObjcBindingApiDefinition>@(ObjcBindingApiDefinition)</_ExpandedObjcBindingApiDefinition>
    <IsBindingProject Condition="'$(_ExpandedObjcBindingApiDefinition)' != ''">true</IsBindingProject>
  </PropertyGroup>

  <!-- Figure out the app bundle extension -->
  <PropertyGroup Condition="'$(AppBundleExtension)' == ''">
    <!-- The extension for app extensions is .appex -->
    <AppBundleExtension Condition="'$(IsAppExtension)' == 'true'">.appex</AppBundleExtension>
    <!-- Otherwise use .app as the extension -->
    <AppBundleExtension Condition="'$(AppBundleExtension)' == ''">.app</AppBundleExtension>
  </PropertyGroup>

  <Target Name="ValidateArchitecture" Condition="'$(IsBindingProject)' != 'true'">
    <Error Text="The project file must specify a value for the MtouchArch or the TargetDeviceArchitecture property." Condition="'$(MtouchArch)' == ''"/>
    <Error Text="The project file does not specify a valid value for the MtouchArch property ($(MtouchArch)). Valid values are: i386, x86_64, ARMv7, ARMv7s and ARM64." Condition="'$(TargetDeviceArchitecture)' == ''"/>
    <Error Text="The project file does not specify a valid value for the TargetDeviceArchitecture property ($(TargetDeviceArchitecture)). Valid values are: Simulator and Device." Condition="'$(TargetDeviceArchitecture)' != 'Simulator' And '$(TargetDeviceArchitecture)' != 'Device'"/>
  </Target>

  <PropertyGroup Condition=" '$(TargetDeviceArchitecture)' == 'Simulator' ">
    <MtouchArch Condition="'$(MtouchArch)' == ''">x86_64</MtouchArch>
    <MtouchLink Condition="'$(MtouchLink)' == ''">None</MtouchLink>
  </PropertyGroup>

  <PropertyGroup Condition=" '$(TargetDeviceArchitecture)' == 'Device' ">
    <MtouchArch Condition="'$(MtouchArch)' == ''">ARM64</MtouchArch>
    <MtouchLink Condition="'$(MtouchLink)' == ''">SdkOnly</MtouchLink>
    <CodesignEntitlements Condition="'$(CodesignEntitlements)' == '' And Exists ('$(MSBuildProjectDirectory)\Entitlements.plist')">$(MSBuildProjectDirectory)\Entitlements.plist</CodesignEntitlements>
    <CodesignKey Condition="'$(CodesignKey)' == ''">iPhone Developer</CodesignKey>
  </PropertyGroup>

  <PropertyGroup>
    <IntermediateOutputPath>$(MSBuildProjectDirectory)\bin\$(Platform)\$(Configuration)\$(TargetDeviceArchitecture)\</IntermediateOutputPath>
    <OutputPath>$(MSBuildProjectDirectory)\bin\$(Platform)\$(Configuration)\$(TargetDeviceArchitecture)\</OutputPath>
  </PropertyGroup>

  <ItemGroup>
    <Folder Include="$(MSBuildProjectDirectory)\Resources\" />
  </ItemGroup>

  <ImportGroup Condition="'$(IsMultiTargetingBuild)' != 'true'">
    <Import Project="..\targets\Xamarin.iOS.TargetFrameworkInference.targets" Condition="'$(TargetFramework)' != '' AND !($(TargetFramework.Contains(',')) OR $(TargetFramework.Contains(';')))"/>
  </ImportGroup>

  <Import Sdk="Microsoft.NET.Sdk" Project="Sdk.targets" />
  <Import Project="$(XamariniOSDotNetRootDirectory)lib\msbuild\iOS\Xamarin.iOS.CSharp.targets" Condition="'$(IsBindingProject)' != 'true'" />
  <Import Project="$(XamariniOSDotNetRootDirectory)lib\msbuild\iOS\Xamarin.iOS.ObjCBinding.CSharp.targets" Condition="'$(IsBindingProject)' == 'true'" />

  <PropertyGroup>
    <BuildDependsOn>
      ValidateArchitecture;
      $(BuildDependsOn);
    </BuildDependsOn>
  </PropertyGroup>

  <PropertyGroup>
    <PublishDependsOn>
      Build;
    </PublishDependsOn>
  </PropertyGroup>

  <Target Name="Publish"
        DependsOnTargets="$(PublishDependsOn)"
        Condition=" '$(IsGraphBuild)' != 'true' ">
    <Exec Condition="'$(Platform)' == 'iPhoneSimulator'" Command="$(MlaunchPath) -installsim=$(OutputPath)\$(AssemblyName).app -device=:v2:runtime=com.apple.CoreSimulator.SimRuntime.iOS-13-3,devicetype=com.apple.CoreSimulator.SimDeviceType.iPhone-11" />
    <Exec Condition="'$(Platform)' == 'iPhone'" Command="$(MlaunchPath) -installdev=$(OutputPath)\$(AssemblyName).app" />
    <Message Importance="High" Text="!!!! Publishing done !!!!" />
  </Target>
</Project>
