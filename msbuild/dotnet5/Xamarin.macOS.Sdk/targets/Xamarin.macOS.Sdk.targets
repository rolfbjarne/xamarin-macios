<?xml version="1.0" encoding="utf-8"?>
<Project DefaultTargets="Build" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <PropertyGroup>
    <NoStdLib>true</NoStdLib>
    <DisableExtraReferences>true</DisableExtraReferences>
  </PropertyGroup>

  <!-- Figure out the app bundle extension -->
  <PropertyGroup Condition="'$(AppBundleExtension)' == ''">
    <!-- The extension for app extensions is .appex -->
    <AppBundleExtension Condition="'$(IsAppExtension)' == 'true'">.appex</AppBundleExtension>
    <!-- Otherwise use .app as the extension -->
    <AppBundleExtension Condition="'$(AppBundleExtension)' == ''">.app</AppBundleExtension>
  </PropertyGroup>

  <!-- Figure out what kind of project we are -->
  <PropertyGroup>
    <!-- Are we a project that outputs a bundle? This is an executable or app extension project -->
    <IsAppBundle Condition="'$(IsAppBundle)' == '' And ('$(OutputType)' == 'Exe' Or '$(IsAppExtension)' == 'true')">true</IsAppBundle>
    <IsAppBundle Condition="'$(IsAppBundle)' == ''">false</IsAppBundle>
  </PropertyGroup>

  <Target Name="_ValidateXamarinConfiguration" Condition="'$(IsAppBundle)' == 'true'">
    <Error Text="Invalid language: $(_ProjectLanguage). Valid languages: C# and F#." Condition=" '$(_ProjectLanguage)' == '' " />
  </Target>

  <PropertyGroup>
    <CodesignEntitlements Condition="'$(CodesignEntitlements)' == '' And Exists ('$(MSBuildProjectDirectory)\Entitlements.plist')">$(MSBuildProjectDirectory)\Entitlements.plist</CodesignEntitlements>
    <!-- Make it possible to disable CodesignEntitlements by setting it to 'None' -->
    <CodesignEntitlements Condition="'$(CodesignEntitlements)' == 'None' "></CodesignEntitlements>
    <CodesignKey Condition="'$(CodesignKey)' == ''">Mac Developer</CodesignKey>
  </PropertyGroup>

  <PropertyGroup>
    <IntermediateOutputPath>$(MSBuildProjectDirectory)\bin\$(Platform)\$(Configuration)\$(TargetDeviceArchitecture)\</IntermediateOutputPath>
    <OutputPath>$(MSBuildProjectDirectory)\bin\$(Platform)\$(Configuration)\$(TargetDeviceArchitecture)\</OutputPath>
  </PropertyGroup>

  <ItemGroup>
    <Folder Include="$(MSBuildProjectDirectory)\Resources\" />
  </ItemGroup>

  <ImportGroup Condition="'$(IsMultiTargetingBuild)' != 'true'">
    <Import Project="..\targets\Xamarin.$(_PlatformName).TargetFrameworkInference.targets" Condition="'$(TargetFramework)' != '' AND !($(TargetFramework.Contains(',')) OR $(TargetFramework.Contains(';')))"/>
  </ImportGroup>

  <Import Sdk="Microsoft.NET.Sdk" Project="Sdk.targets" />


  <!-- Project types and how do we distinguish between them

                                  OutputType   Custom variable
    ==================================================================
    macOS Executable Project        Exe
    macOS App Extension Project     Library      IsAppExtension
    macOS Binding Project           Library      IsBindingProject
    macOS Class Library Project     Library

  -->

  <PropertyGroup>
    <_ProjectType Condition="'$(_ProjectType)' == '' And '$(_PlatformName)' == 'macOS' And '$(OutputType)' == 'Exe'">macOSExecutableProject</_ProjectType>
    <_ProjectType Condition="'$(_ProjectType)' == '' And '$(_PlatformName)' == 'macOS' And '$(OutputType)' == 'Library' And '$(IsAppExtension)' != ''">macOSAppExtensionProject</_ProjectType>
    <_ProjectType Condition="'$(_ProjectType)' == '' And '$(_PlatformName)' == 'macOS' And '$(OutputType)' == 'Library' And '$(IsBindingProject)' != ''">macOSBindingProject</_ProjectType>
    <_ProjectType Condition="'$(_ProjectType)' == '' And '$(_PlatformName)' == 'macOS' And '$(OutputType)' == 'Library'">macOSClassLibrary</_ProjectType>

    <!-- Language? -->
    <_ProjectLanguage>$(Language)</_ProjectLanguage>
    <_ProjectLanguage Condition="'$(_ProjectLanguage)' == '' Or '$(_ProjectLanguage)' == 'C#' ">CSharp</_ProjectLanguage>
    <_ProjectLanguage Condition="'$(_ProjectLanguage)' == 'F#' ">FSharp</_ProjectLanguage>
  </PropertyGroup>

  <Import Project="$(XamarinMacDotNetRootDirectory)lib\msbuild\Xamarin.Mac.$(_ProjectLanguage).targets"              Condition="'$(_ProjectType)' == 'macOSExecutableProject' Or '$(_ProjectType)' == 'macOSClassLibrary' " />
  <Import Project="$(XamarinMacDotNetRootDirectory)lib\msbuild\Xamarin.Mac.AppExtension.$(_ProjectLanguage).targets" Condition="'$(_ProjectType)' == 'macOSAppExtensionProject' " />
  <Import Project="$(XamarinMacDotNetRootDirectory)lib\msbuild\Xamarin.Mac.ObjCBinding.$(_ProjectLanguage).targets"  Condition="'$(_ProjectType)' == 'macOSBindingProject' " />

  <!-- Do some validation before the build -->
  <PropertyGroup>
    <BuildDependsOn>
      _ValidateXamarinConfiguration;
      $(BuildDependsOn);
    </BuildDependsOn>
  </PropertyGroup>
</Project>
