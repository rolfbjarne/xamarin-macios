<?xml version="1.0" encoding="utf-8"?>
<Project Sdk="Microsoft.NET.Sdk">
  <PropertyGroup>
    <TargetFramework>net$(BundledNETCoreAppTargetFrameworkVersion)-ios</TargetFramework>
    <IlcKeepManagedDebuggerSupport>true</IlcKeepManagedDebuggerSupport> <!-- https://github.com/dotnet/runtime/issues/86186 -->
    <EnableAssemblyILStripping>false</EnableAssemblyILStripping>
    <CustomNativeMain>true</CustomNativeMain>
    <IlcCompileDependsOn>Compile;_ComputeLinkerArguments;_XamarinILLink;SetupOSSpecificProps;PrepareForILLink;_XamarinComputeIlcCompileInputs</IlcCompileDependsOn>
  </PropertyGroup>

  <ItemGroup>
    <CustomLinkerArg Include="-miphoneos-version-min=11.0" />
    <CustomLinkerArg Include="-isysroot /Applications/Xcode_14.3.0.app/Contents/Developer/Platforms/iPhoneOS.platform/Developer/SDKs/iPhoneOS16.4.sdk" />
  </ItemGroup>

  <!-- Imports of the form '../shared.csproj' will be inlined by xharness -->
  <Import Project="../shared.csproj" />

  <ItemGroup>
    <!-- this empty item group is here for xharness -->
  </ItemGroup>

  <Target Name="_ComputeResolvedFilesToPublishList" DependsOnTargets="$(ComputeResolvedFilesToPublishList)" Condition="'$(_XamarinRuntime)' != 'NativeAOT'" />
  <Target Name="_ComputeResolvedFilesToPublishList" Condition="'$(_XamarinRuntime)' != 'NativeAOT'" />


  <Target Name="_XamarinILLink" Inputs="@(ManagedAssemblyToLink)" Outputs="@(ManagedAssemblyToLink->'$(IntermediateLinkDir)%(Filename)%(Extension)')" DependsOnTargets="_RunILLink" />

  <Target Name="_XamarinComputeIlcCompileInputs">
    <PropertyGroup>
      <NativeLib>static</NativeLib>
    </PropertyGroup>

    <ItemGroup>
      <DirectPInvoke Include="__Internal" />

      <_UpdatedManagedAssemblyToLink Include="@(ManagedAssemblyToLink->'$(IntermediateLinkDir)%(Filename)%(Extension)')" Condition="Exists('$(IntermediateLinkDir)%(Filename)%(Extension)')" />
      <ManagedAssemblyToLink Remove="@(ManagedAssemblyToLink)" />
      <ManagedAssemblyToLink Include="@(_UpdatedManagedAssemblyToLink)" />

      <UnmanagedEntryPointsAssembly Remove="System.Private.CoreLib" />
      <UnmanagedEntryPointsAssembly Include="@(_UpdatedManagedAssemblyToLink->'%(Filename)')" />

      <ManagedBinary Include="$(IntermediateLinkDir)$(TargetName)$(TargetExt)" />
      <IlcCompileInput Include="@(ManagedBinary)" />
      <IlcReference Include="@(ManagedAssemblyToLink->'$(IntermediateLinkDir)%(Filename)%(Extension)')" Exclude="@(ManagedBinary)" />

      <TrimmerRootAssembly Remove="@(TrimmerRootAssembly)" />
      <!--<TrimmerRootAssembly Include="@(ManagedAssemblyToLink->'$(IntermediateLinkDir)%(Filename)%(Extension)')" />-->

      <IlcArg Condition="'$(Registrar)' == 'managed-static'" Include="--feature:ObjCRuntime.Runtime.IsManagedStaticRegistrar=true" />
      <IlcArg Condition="'$(Registrar)' != 'managed-static'" Include="--feature:ObjCRuntime.Runtime.IsManagedStaticRegistrar=false" />
      <IlcArg Include="--defaultrooting" />

      <_NativeExecutableObjectFiles Include="$(NativeObject)" />
      <LinkerArg Remove="@(NativeFramework->'-framework %(Identity)')" />
      <_CustomLinkFlags Include="@(LinkerArg)" />
    </ItemGroup>
  </Target>

  <!-- Override the NativeAOT targets -->
  <Target Name="ComputeLinkedFilesToPublish" BeforeTargets="ComputeResolvedFilesToPublishList" DependsOnTargets="_ComputeAssembliesToCompileToNative;LinkNative" />
  <Target Name="LinkNative" DependsOnTargets="$(LinkNativeDependsOn)" />

</Project>
