
# job that downloads the html report from the artifacts and uploads them into vsdrops.

steps:

- template: ../common/checkout.yml

# Download the change detection artifact
- task: DownloadPipelineArtifact@2
  displayName: 'Download change detection artifacts'
  inputs:
    patterns: 'change-detection/change-detection.zip'
    allowFailedBuilds: true
    path: $(System.DefaultWorkingDirectory)/Artifacts

# Unzip the change detection artifact
- task: ExtractFiles@1
  displayName: 'Decompress change detection artifacts'
  inputs:
    archiveFilePatterns: '$(System.DefaultWorkingDirectory)/Artifacts/change-detection/change-detection.zip'
    destinationFolder: '$(System.DefaultWorkingDirectory)/change-detection'
# Debug stuff
- bash: |
    find "${SYSTEM_DEFAULTWORKINGDIRECTORY//\\//}/Artifacts"
    exit 0
  displayName: "Dump Downloaded contents"
  continueOnError: true

# Upload the change detection results to vsdrops
- task: ms-vscs-artifact.build-tasks.artifactDropTask-1.artifactDropTask@0
  displayName: 'Publish change detection results to Artifact Services Drop'
  continueOnError: true
  inputs:
    dropServiceURI: 'https://devdiv.artifacts.visualstudio.com/DefaultCollection'
    dropMetadataContainerName: 'DropMetadata-ChangeDetection'
    buildNumber: 'xamarin-macios/detected-changes/$(Build.BuildNumber)/$(Build.BuildId)'
    sourcePath: '$(System.DefaultWorkingDirectory)/change-detection/'
    detailedLog: true
    usePat: true
